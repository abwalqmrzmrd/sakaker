<!-- ğŸ”¹ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
<div id="chat-icon" title="ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©" style="
    position:fixed;bottom:200px;right:20px;width:60px;height:60px;
    border-radius:50%;background:rgba(255,255,255,0.2);
    display:flex;align-items:center;justify-content:center;font-size:14px;
    text-align:center;line-height:1.2;z-index:9999;cursor:pointer;
    border:2px solid white;backdrop-filter:blur(5px);font-weight:bold;color:white;">
Ø¯Ø±Ø¯Ø´Ø©
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© -->
<div id="chat-box" style="
    position:fixed;bottom:100px;right:15px;width:320px;height:420px;
    background:rgba(0,0,0,0.9);border:2px solid #00BFFF;border-radius:12px;
    display:none;flex-direction:column;z-index:9998;overflow:hidden;">
  <div id="chat-header" style="
      padding:8px;background:red;border-bottom:1px solid #FFD700;
      color:black;text-align:center;cursor:move;position:relative;">
    ğŸ‘¥ <span id="visitor-count">0</span>
    <button id="close-chat" style="
        position:absolute;left:8px;top:6px;background:rgba(255,215,0,0.12);
        border-radius:6px;padding:3px 6px;border:1px solid #FFD700;
        color:black;cursor:pointer;">ğŸ”™</button>
    <div id="status-bar" style="font-size:12px;margin-top:6px;display:flex;justify-content:space-between;">
      <span id="internet-status">ğŸŒ ØºÙŠØ± Ù…ØªØµÙ„</span>
      <span id="server-status">â˜ï¸ ØºÙŠØ± Ù…ØªØµÙ„</span>
    </div>
  </div>
  <div id="chat-messages" style="
      flex:1;overflow-y:auto;padding:8px;text-align:right;font-size:13px"></div>
  <div id="chat-input" style="
      padding:8px;border-top:1px solid #00BFFF;background:rgba(0,0,0,0.92);
      display:flex;flex-direction:column;gap:6px">
    <input type="text" id="usernameInput" placeholder="Ø§Ø³Ù…Ùƒ" style="
        flex:1;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.06);
        color:#fff"/>
    <div class="row" style="display:flex;gap:6px">
      <input type="text" id="messageInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." style="
          flex:1;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.06);
          color:#fff"/>
      <button id="sendBtn" class="send-btn" style="
          padding:8px 10px;border-radius:8px;border:none;cursor:pointer;
          background:linear-gradient(45deg,#FFD700,#00BFFF);font-weight:bold;color:#000">Ø¥Ø±Ø³Ø§Ù„</button>
    </div>
  </div>
</div>

<style>
/* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
#chat-messages div {
  background: rgba(255,255,255,0.05);
  margin: 4px 0;
  padding: 4px 8px;
  border-radius: 6px;
  word-wrap: break-word;
}

/* ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù‡Ø§ØªÙ */
@media screen and (max-width: 480px){
  #chat-box { width: 90%; height: 300px; bottom: 80px; right: 5%; }
  #chat-icon { width: 50px; height: 50px; font-size: 12px; }
}
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

// ğŸ” Ù…ÙØªØ§Ø­ Ù…Ø®ÙÙŠ
const _key = ["AIzaSy","DDPcEIVAn-","xv6dKcPrTzDeOIxSA8M58v8"];
const firebaseConfig = {
  apiKey: _key.join(""),
  authDomain: "abwalqmrzmrd-47557.firebaseapp.com",
  databaseURL: "https://abwalqmrzmrd-47557-default-rtdb.firebaseio.com/",
  projectId: "abwalqmrzmrd-47557",
  storageBucket: "abwalqmrzmrd-47557.appspot.com",
  messagingSenderId: "957400167542",
  appId: "1:957400167542:web:a3b341fad9b1142aaedb57"
};

const chatIcon=document.getElementById("chat-icon");
const chatBox=document.getElementById("chat-box");
const closeBtn=document.getElementById("close-chat");
const visitorEl=document.getElementById("visitor-count");
const internetEl=document.getElementById("internet-status");
const serverEl=document.getElementById("server-status");
const sendBtn=document.getElementById("sendBtn");
const usernameInput=document.getElementById("usernameInput");
const messageInput=document.getElementById("messageInput");
const messagesBox=document.getElementById("chat-messages");

let chatInitialized=false;

// ğŸŒ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª
function updateInternetStatus(){
  if(navigator.onLine){
    internetEl.textContent="ğŸŒ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª";
    internetEl.style.color="lime";
  } else {
    internetEl.textContent="ğŸŒ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª";
    internetEl.style.color="red";
  }
}
window.addEventListener("online",updateInternetStatus);
window.addEventListener("offline",updateInternetStatus);
updateInternetStatus();

// ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
chatIcon.addEventListener("click",initChatConnection);
closeBtn.addEventListener("click",()=>{chatBox.style.display="none";chatIcon.style.display="flex";});

async function initChatConnection(){
  chatBox.style.display="flex";
  chatIcon.style.display="none";
  if(chatInitialized) return;
  chatInitialized=true;

  const app=initializeApp(firebaseConfig);
  const db=getDatabase(app);

  // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…
  try{
    await set(ref(db,"test_connection"),{time:Date.now()});
    serverEl.textContent="â˜ï¸ Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
    serverEl.style.color="lime";
  }catch(e){
    serverEl.textContent="â˜ï¸ ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…";
    serverEl.style.color="red";
  }

  // Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø²ÙˆØ§Ø±
  try{
    const visitorsRef=ref(db,"visitors");
    const myRef=push(visitorsRef);
    await set(myRef,{online:true,time:Date.now()});
    onDisconnect(myRef).remove();
    onValue(visitorsRef,snap=>{
      visitorEl.textContent=Object.keys(snap.val()||{}).length;
    });
  }catch(e){console.error(e);}

  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¨Ø§Ø´Ø±Ø©
  try{
    const chatRef=ref(db,"chat");
    onValue(chatRef,snap=>{
      messagesBox.innerHTML="";
      snap.forEach(child=>{
        const m=child.val();
        const t=m.time?(" ["+new Date(m.time).toLocaleTimeString()+"]"):"";
        const div=document.createElement("div");
        div.textContent=`${m.name||"Ø²Ø§Ø¦Ø±"}${t}: ${m.message||""}`;
        messagesBox.appendChild(div);
      });
      messagesBox.scrollTop=messagesBox.scrollHeight;
    });
  }catch(e){console.error(e);}

  // Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
  sendBtn.addEventListener("click",async()=>{
    const name=usernameInput.value.trim()||"Ø²Ø§Ø¦Ø±";
    const msg=messageInput.value.trim();
    if(!msg) return alert("Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§");
    if(!navigator.onLine) return alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª");

    try{
      const msgRef=push(ref(db,"chat"));
      await set(msgRef,{name,message:msg,time:Date.now()});
      messageInput.value="";

      // Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 60 Ø«Ø§Ù†ÙŠØ©
      setTimeout(()=>{msgRef.remove().catch(console.error);},60000);
    }catch(e){alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„");}
  });
}

// Ø³Ø­Ø¨ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù…Ù† Ø§Ù„Ø±Ø£Ø³
(function enableDrag(){
  const header=document.getElementById("chat-header");
  const box=document.getElementById("chat-box");
  let dragging=false,ox=0,oy=0;

  header.addEventListener("mousedown",start);
  header.addEventListener("touchstart",start);

  function start(e){
    dragging=true;
    const ev=e.touches?e.touches[0]:e;
    const rect=box.getBoundingClientRect();
    ox=ev.clientX-rect.left;
    oy=ev.clientY-rect.top;
    document.addEventListener("mousemove",move);
    document.addEventListener("mouseup",end);
    document.addEventListener("touchmove",move,{passive:false});
    document.addEventListener("touchend",end);
  }

  function move(e){
    if(!dragging) return;
    const ev=e.touches?e.touches[0]:e;
    let x=ev.clientX-ox, y=ev.clientY-oy;
    x=Math.max(0,Math.min(window.innerWidth-box.offsetWidth,x));
    y=Math.max(0,Math.min(window.innerHeight-box.offsetHeight,y));
    box.style.left=x+"px";
    box.style.top=y+"px";
    box.style.bottom="auto";
    box.style.right="auto";
  }

  function end(){
    dragging=false;
    document.removeEventListener("mousemove",move);
    document.removeEventListener("mouseup",end);
    document.removeEventListener("touchmove",move);
    document.removeEventListener("touchend",end);
  }
})();
</script>
